<!DOCTYPE html>
<meta charset="utf-8">
<title>Canvas-Sandbox</title>
<script src="lib/codemirror/codemirror.js"></script>
<script src="lib/codemirror/javascript.js"></script>
<link rel="stylesheet" href="lib/codemirror/codemirror.css">
<link rel="stylesheet" href="lib/codemirror/neat.css">
<style>
body { margin:8px 16px; }
h1 { display:none; }
dt, dd { display: block; float:left; margin:0 0 8px 0; }
dt { clear: both; }
dd { padding-left:8px; }
canvas { display:block; cursor:crosshair; }
.CodeMirror-scroll { cursor:text; }
canvas, .CodeMirror-scroll {  border:1px solid #333; box-shadow:0 0 16px -4px #999; }
#main { float:left; width:640px; }
#side { float:left; padding-left:24px; }
.CodeMirror { font-size: 14px; } /* Default font size */
.CodeMirror-lines { padding-left: 1.1em; } /* For larger font sizes */
</style>
<h1>Canvas Sandbox</h1>
<div id="main">
	<canvas height="320" width="640" id="canvas"></canvas>
	<br>
	<textarea id="query" cols="60" rows="10"></textarea>
	<br>
	<input type="button" value="Ausführen" id="execute">
</div>
<div id="side">
	<dl>
		<dt>Canvas-Element:</dt>
		<dd><code>canvas</code></dd>
		<dt>2D-Context:</dt>
		<dd><code>context</code></dd>
		<dt>Winkel-Umrechner:</dt>
		<dd><code>Math.toRad(deg)</code></dd>
		<dt>Cursorposition:</dt>
		<dd><span id="posX">NA</span> / <span id="posY">NA</span></dd>
		<dt>Spezifikationen:</dt>
		<dd><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-canvas-element.html">WHATWG</a>
		<dt>Cheat Sheet:</dt>
		<dd><a href="http://www.nihilogic.dk/labs/canvas_sheet/HTML5_Canvas_Cheat_Sheet.pdf">nihilogic.dk</a>
		<dt>Editor-Schrift:</dt>
		<dd><input type="number" id="EditorFontSize" min="14"></dd>
	</dl>
</div>
<script>

var $ = function(id){
	return document.getElementById(id);
}
var $$ = function(className){
	return document.getElementsByClassName(className);
}

// Globale vars
var canvas = $('canvas'),
    context = canvas.getContext('2d');
Math.toRad = function(x){
	return (x * Math.PI) / 180;
};

// Ab hier interne Funktionalität
(function(){
"use strict";

var textarea     = $('query'),
    execute      = $('execute'),
    reset        = $('reset'),
    posX         = $('posX'),
    posY         = $('posY'),
    fontsize     = $('EditorFontSize');

/* Create editor */
var editor = CodeMirror.fromTextArea(textarea, {
	mode: 'javascript',
	theme: 'neat',
	indentUnit: 4,
	lineNumbers: true
});

/* Editor font size */
var changesize = function(){
	var box = $$('CodeMirror')[0],
	    val = (fontsize.value && parseInt(fontsize.value) > 14) ? fontsize.value : 14;
	box.style.fontSize = val + 'px';
	window.localStorage.setItem('settingsRecovery', val);
};
fontsize.onkeyup = changesize;
fontsize.onchange = changesize;

/* http://www.quirksmode.org/js/findpos.html */
var findPos = function(obj) {
	var curleft = 0,
	    curtop = 0;
	if(obj.offsetParent){
		do {
			curleft += obj.offsetLeft;
			curtop  += obj.offsetTop;
		} while (obj = obj.offsetParent);
		return [curleft,curtop];
	}
};

/* Show coordinates */
canvas.onmousemove = function(evt){
	var x = evt.clientX + document.body.scrollLeft + document.documentElement.scrollLeft - findPos(canvas)[0],
	    y = evt.clientY + document.body.scrollTop  + document.documentElement.scrollTop  - findPos(canvas)[1];
	posX.innerHTML = x;
	posY.innerHTML = y;
};
canvas.onmouseout = function(){
	posX.innerHTML = posY.innerHTML = 'NA';
};

/* Execute! */
execute.onclick = function(){
	var val = editor.getValue();
	if(val){
		try {
			if(window.localStorage){
				window.localStorage.setItem('codeRecovery', val);
			}
			eval(val);
		}
		catch(e){
			window.alert("Script-Fehler! " + e);
		}
	}
};

/* Restore last session after reload */
window.onload = function(){
	editor.focus();
	if(window.localStorage){
		var restoredCode = window.localStorage.getItem('codeRecovery');
		if(restoredCode && editor.getValue() == ''){
			editor.setValue(restoredCode);
		}
		var restoredSettings = window.localStorage.getItem('settingsRecovery');
		if(restoredSettings && fontsize.value == ''){
			fontsize.value = restoredSettings;
			changesize();
		}
	}
};

})();

</script>
